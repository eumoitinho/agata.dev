# Docker Compose for local development
version: '3.8'

services:
  # Main deployment service
  deploy-azure:
    build:
      context: .
      dockerfile: docker/Dockerfile.build
    environment:
      - NODE_ENV=development
      - AZURE_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID}
      - AZURE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}
      - AZURE_CONTAINER_REGISTRY=${AZURE_CONTAINER_REGISTRY}
      - AZURE_SERVICE_BUS_CONNECTION_STRING=${AZURE_SERVICE_BUS_CONNECTION_STRING}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_COSMOS_CONNECTION_STRING=${AZURE_COSMOS_CONNECTION_STRING}
      - AZURE_KEY_VAULT_URI=${AZURE_KEY_VAULT_URI}
      - LOG_LEVEL=debug
    ports:
      - "3010:3000"
    volumes:
      - ./src:/workspace/src:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - libra-network

  # Local Cosmos DB emulator (for development)
  cosmos-emulator:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
    environment:
      - AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10
      - AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE=true
    ports:
      - "8081:8081"
      - "10251-10255:10251-10255"
    volumes:
      - cosmos-data:/data/db
    networks:
      - libra-network

  # Local Service Bus (using RabbitMQ as substitute)
  servicebus-local:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - libra-network

  # Local blob storage (using MinIO)
  blob-storage:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    networks:
      - libra-network

volumes:
  cosmos-data:
  rabbitmq-data:
  minio-data:

networks:
  libra-network:
    driver: bridge